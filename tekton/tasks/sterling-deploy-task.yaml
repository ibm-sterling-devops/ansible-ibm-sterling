---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sterling-deploy-task
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Deployment
    tekton.dev/tags: ansible, git, sterling, ibm
    tekton.dev/displayName: "ansible deployment with persistent credentials"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task performs git clone and runs Ansible playbook using a custom
    Docker image. Each run starts fresh with a new clone.
  params:
    - name: playbook-path
      description: Path to the Ansible playbook relative to the repository root
      type: string
    - name: configmap-name
      description: Name of the ConfigMap containing deployment configuration
      type: string
      default: "sterling-deploy-config"
    - name: custom-image
      description: Custom Docker image with oc, kubectl, helm, git, ansible
      type: string
      default: "quay.io/ibm-sterling-devops/sterling-cli:1.0.0"
    - name: verbose
      description: Ansible verbosity level (-v, -vv, -vvv, -vvvv)
      type: string
      default: ""
    - name: extra-args
      description: Extra arguments to pass to ansible-playbook
      type: string
      default: ""
  steps:
    - name: git-pull-and-deploy
      image: $(params.custom-image)
      imagePullPolicy: Always
      env:
        - name: GIT_URL
          value: "https://github.com/ibm-sterling-devops/ansible-ibm-sterling.git"
        - name: PLAYBOOK_PATH
          value: $(params.playbook-path)
        - name: WORK_DIR
          value: /opt/app-root/src
      envFrom:
        - configMapRef:
            name: $(params.configmap-name)
            optional: true
        - secretRef:
            name: sterling-deploy-secrets
            optional: false
      script: |
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "Sterling Ansible Deployment Task"
        echo "=========================================="
        echo "Playbook: ${PLAYBOOK_PATH}"
        echo "Working Directory: ${WORK_DIR}"
        echo "=========================================="
        
        # Configure OpenShift/Kubernetes authentication
        echo "Configuring OpenShift authentication..."
        
        if [ -z "${OCP_SERVER}" ] || [ -z "${OCP_TOKEN}" ]; then
          echo "ERROR: OCP_SERVER or OCP_TOKEN not set"
          echo "Please run setup-credentials.sh script first"
          exit 1
        fi
        
        # Login to OpenShift using credentials from secret
        echo "Logging in to OpenShift..."
        oc login --server="${OCP_SERVER}" --token="${OCP_TOKEN}"
        
        # Verify login
        echo "Logged in as: $(oc whoami)"
        echo "Current project: $(oc project -q)"
        
        # Export KUBECONFIG for Ansible kubernetes.core modules
        export KUBECONFIG="${HOME}/.kube/config"
        export K8S_AUTH_KUBECONFIG="${KUBECONFIG}"
        
        # Preserve ENTITLED_REGISTRY_KEY
        if [ -n "${ENTITLED_REGISTRY_KEY}" ]; then
          echo "ENTITLED_REGISTRY_KEY is set"
          export ENTITLED_REGISTRY_KEY="${ENTITLED_REGISTRY_KEY}"
        fi

        echo "=========================================="
        
        # Change to working directory
        cd "ansible-ibm-sterling"

        # Clone repository (fresh clone every time)
        echo "Update repository..."
        git pull 
        echo "Git pull completed"

        echo "=========================================="
        echo "Current commit:"
        git log -1 --oneline
        echo "=========================================="

        # Verify playbook exists
        if [ ! -f "${PLAYBOOK_PATH}" ]; then
          echo "ERROR: Playbook not found: ${PLAYBOOK_PATH}"
          exit 1
        fi

        # Build ansible-playbook command
        ANSIBLE_CMD="ansible-playbook"
        
        if [ -n "$(params.verbose)" ]; then
          ANSIBLE_CMD="${ANSIBLE_CMD} $(params.verbose)"
        fi
        
        if [ -n "$(params.extra-args)" ]; then
          ANSIBLE_CMD="${ANSIBLE_CMD} $(params.extra-args)"
        fi
        
        ANSIBLE_CMD="${ANSIBLE_CMD} ${PLAYBOOK_PATH}"

        echo "Executing: ${ANSIBLE_CMD}"
        echo "=========================================="
        
        # Execute playbook
        ${ANSIBLE_CMD}
        
        EXIT_CODE=$?
        echo "=========================================="
        if [ ${EXIT_CODE} -eq 0 ]; then
          echo "✓ Deployment completed SUCCESSFULLY"
        else
          echo "❌ Deployment FAILED with exit code: ${EXIT_CODE}"
        fi
        echo "=========================================="
        
        exit ${EXIT_CODE}
