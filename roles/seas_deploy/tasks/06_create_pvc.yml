---
# Create PVC
# -----------------------------------------------------------------------------
- name: "Create PVC for SEAS"
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ seas_helm_release }}-ibm-seas-pvc-{{ my_serial }}"
        namespace: "{{ seas_namespace }}"
        labels:
          app.kubernetes.io/app-instance: "{{ seas_helm_release }}-ibm-seas-pvc-{{ my_serial }}"
          app.kubernetes.io/name: ibm-seas
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: "{{ storage_class_matrix[storage_class_provider].rwo }}"
        volumeMode: Filesystem
        resources:
          requests:
            storage: "{{ seas_pvc_storage_size }}"

- name: Wait for PVC to be Bound
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    name: "{{ seas_helm_release }}-ibm-seas-pvc-{{ my_serial }}"
    namespace: "{{ seas_namespace }}"
  register: pvc_info
  until: pvc_info.resources[0].status.phase == 'Bound'
  retries: 15  # Total retries will be 15 * 20s = 300s (5 minutes)
  delay: 20     # Wait for 20 seconds between each retry

- name: Debug PVC
  ansible.builtin.debug:
    msg: "PVC is ready"
